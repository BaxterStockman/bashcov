#!/usr/bin/env ruby
# frozen_string_literal: true

lib = File.expand_path("../../lib", __FILE__)
$LOAD_PATH.unshift(lib) unless $LOAD_PATH.include?(lib)

require "bashcov"

Bashcov.parse_options! ARGV

if Bashcov.show_ps4
  require 'shellwords'
  Bashcov::Xtrace.delimiter = ':'
  puts "PS4=#{Shellwords.shellescape(Bashcov::Xtrace.ps4)}"
  exit 0
end

runner = Bashcov::Runner.new Bashcov.command
status = runner.run

if Bashcov.dump
  require "yaml"

  dump = Hash[runner.files.map { |f, sf| [f.to_s, sf.dump] }]
  puts dump.to_yaml
else
  coverage = runner.result

  require "simplecov"

  SimpleCov.command_name Bashcov.fullname
  SimpleCov.root Bashcov.root_directory
  SimpleCov::Result.new(coverage).format!
end

exit status.exitstatus
